import { defineType, defineField } from 'sanity';

export default defineType({
  name: 'product',
  title: 'Product',
  type: 'document',
  groups: [
    { name: 'basic', title: 'Basic Info', default: true },
    { name: 'media', title: 'Images' },
    { name: 'pricing', title: 'Pricing & Variations' },
    { name: 'personalization', title: 'Personalization' },
    { name: 'shipping', title: 'Shipping & Processing' },
    { name: 'organization', title: 'Organization' },
  ],
  fields: [
    // BASIC INFO GROUP
    defineField({
      name: 'title',
      title: 'Product Title',
      type: 'string',
      group: 'basic',
      validation: (Rule) => Rule.required().max(140).warning('Keep titles under 140 characters'),
    }),
    defineField({
      name: 'slug',
      title: 'Slug',
      type: 'slug',
      group: 'basic',
      options: {
        source: 'title',
        maxLength: 96,
      },
      validation: (Rule) => Rule.required(),
    }),
    defineField({
      name: 'description',
      title: 'Description',
      type: 'text',
      group: 'basic',
      rows: 5,
      description: 'Full product description',
    }),
    defineField({
      name: 'specialNote',
      title: 'Special Note (Optional)',
      type: 'string',
      group: 'basic',
      description: 'e.g., "ORDER by Jan 19, ships Jan 23" or "SHIPS NOVEMBER 21"',
    }),

    // MEDIA GROUP
    defineField({
      name: 'images',
      title: 'Product Images',
      type: 'array',
      group: 'media',
      of: [
        {
          type: 'image',
          options: {
            hotspot: true,
          },
          fields: [
            {
              name: 'alt',
              title: 'Alt Text',
              type: 'string',
            },
          ],
        },
      ],
      validation: (Rule) => Rule.min(1).error('At least one image is required'),
    }),
    defineField({
      name: 'externalImageUrl',
      title: 'External Image URL (Legacy)',
      type: 'url',
      group: 'media',
      description: 'For Etsy images - will be phased out once all images are uploaded to Sanity',
    }),

    // PRICING & VARIATIONS GROUP
    defineField({
      name: 'basePrice',
      title: 'Base Price',
      type: 'number',
      group: 'pricing',
      validation: (Rule) => Rule.required().positive(),
    }),
    defineField({
      name: 'compareAtPrice',
      title: 'Compare at Price (Original/Sale)',
      type: 'number',
      group: 'pricing',
      description: 'Show as original price when on sale (crossed out)',
    }),
    defineField({
      name: 'sku',
      title: 'SKU',
      type: 'string',
      group: 'pricing',
    }),
    defineField({
      name: 'hasVariations',
      title: 'Has Variations?',
      type: 'boolean',
      group: 'pricing',
      initialValue: false,
      description: 'Enable if this product has different options with different prices',
    }),
    defineField({
      name: 'variations',
      title: 'Variations',
      type: 'array',
      group: 'pricing',
      hidden: ({ document }) => !document?.hasVariations,
      of: [
        {
          type: 'object',
          name: 'variation',
          title: 'Variation',
          fields: [
            {
              name: 'name',
              title: 'Variation Name',
              type: 'string',
              description: 'e.g., "7 Letters", "12 Days", "Pink Heart"',
              validation: (Rule) => Rule.required(),
            },
            {
              name: 'price',
              title: 'Price',
              type: 'number',
              validation: (Rule) => Rule.required().positive(),
            },
            {
              name: 'sku',
              title: 'Variation SKU',
              type: 'string',
            },
            {
              name: 'inStock',
              title: 'In Stock',
              type: 'boolean',
              initialValue: true,
            },
          ],
          preview: {
            select: {
              title: 'name',
              price: 'price',
            },
            prepare({ title, price }) {
              return {
                title: title,
                subtitle: `$${price?.toFixed(2) || '0.00'}`,
              };
            },
          },
        },
      ],
    }),

    // PERSONALIZATION GROUP
    defineField({
      name: 'hasPersonalization',
      title: 'Requires Personalization?',
      type: 'boolean',
      group: 'personalization',
      initialValue: false,
      description: 'Enable if customer must enter personalization details',
    }),
    defineField({
      name: 'personalization',
      title: 'Personalization Settings',
      type: 'object',
      group: 'personalization',
      hidden: ({ document }) => !document?.hasPersonalization,
      fields: [
        {
          name: 'label',
          title: 'Field Label',
          type: 'string',
          description: 'What to call the field, e.g., "Personalization Details", "Child\'s Name"',
          initialValue: 'Personalization Details',
        },
        {
          name: 'instructions',
          title: 'Instructions for Customer',
          type: 'text',
          rows: 4,
          description: 'Explain what info you need from the customer',
        },
        {
          name: 'characterLimit',
          title: 'Character Limit',
          type: 'number',
          initialValue: 256,
          validation: (Rule) => Rule.min(1).max(1000),
        },
        {
          name: 'required',
          title: 'Required?',
          type: 'boolean',
          initialValue: true,
        },
      ],
    }),

    // SHIPPING & PROCESSING GROUP
    defineField({
      name: 'shippingProfile',
      title: 'Shipping Profile',
      type: 'string',
      group: 'shipping',
      options: {
        list: [
          { title: 'Small Envelope (lightweight, flat)', value: 'small-envelope' },
          { title: 'Large Box (heavier, bulky items)', value: 'large-box' },
        ],
        layout: 'radio',
      },
      initialValue: 'small-envelope',
      validation: (Rule) => Rule.required(),
    }),
    defineField({
      name: 'processingTime',
      title: 'Processing Time',
      type: 'string',
      group: 'shipping',
      options: {
        list: [
          { title: '1-3 Business Days', value: '1-3-days' },
          { title: '3-5 Business Days', value: '3-5-days' },
          { title: '5-7 Business Days (Made to Order)', value: '5-7-days' },
          { title: '3-4 Weeks', value: '3-4-weeks' },
          { title: 'Custom Date (specify below)', value: 'custom' },
        ],
      },
      initialValue: '1-3-days',
    }),
    defineField({
      name: 'customProcessingDate',
      title: 'Custom Processing Info',
      type: 'string',
      group: 'shipping',
      hidden: ({ document }) => document?.processingTime !== 'custom',
      description: 'e.g., "Ships November 21" or "10 business days"',
    }),
    defineField({
      name: 'weight',
      title: 'Weight (for shipping)',
      type: 'object',
      group: 'shipping',
      fields: [
        { name: 'pounds', title: 'Pounds', type: 'number', initialValue: 0 },
        { name: 'ounces', title: 'Ounces', type: 'number', initialValue: 0 },
      ],
    }),
    defineField({
      name: 'dimensions',
      title: 'Dimensions (for shipping)',
      type: 'object',
      group: 'shipping',
      fields: [
        { name: 'length', title: 'Length (in)', type: 'number' },
        { name: 'width', title: 'Width (in)', type: 'number' },
        { name: 'height', title: 'Height (in)', type: 'number' },
      ],
    }),

    // ORGANIZATION GROUP
    defineField({
      name: 'category',
      title: 'Category',
      type: 'reference',
      group: 'organization',
      to: [{ type: 'category' }],
      validation: (Rule) => Rule.required(),
    }),
    defineField({
      name: 'tags',
      title: 'Tags',
      type: 'array',
      group: 'organization',
      of: [{ type: 'string' }],
      options: {
        layout: 'tags',
      },
    }),
    defineField({
      name: 'quantity',
      title: 'Inventory Quantity',
      type: 'number',
      group: 'organization',
      initialValue: 10,
      validation: (Rule) => Rule.min(0),
    }),
    defineField({
      name: 'featured',
      title: 'Featured Product',
      type: 'boolean',
      group: 'organization',
      initialValue: false,
      description: 'Show on homepage and prioritize in shop',
    }),
    defineField({
      name: 'active',
      title: 'Active (Visible on Site)',
      type: 'boolean',
      group: 'organization',
      initialValue: true,
      description: 'Uncheck to hide from shop without deleting',
    }),
  ],
  preview: {
    select: {
      title: 'title',
      media: 'images.0',
      price: 'basePrice',
      category: 'category.title',
      active: 'active',
    },
    prepare({ title, media, price, category, active }) {
      return {
        title: `${active ? '' : 'ðŸš« '}${title}`,
        subtitle: `${category || 'No category'} â€¢ $${price?.toFixed(2) || '0.00'}`,
        media,
      };
    },
  },
  orderings: [
    {
      title: 'Featured First',
      name: 'featuredDesc',
      by: [
        { field: 'featured', direction: 'desc' },
        { field: '_createdAt', direction: 'desc' },
      ],
    },
    {
      title: 'Price: Low to High',
      name: 'priceAsc',
      by: [{ field: 'basePrice', direction: 'asc' }],
    },
    {
      title: 'Price: High to Low',
      name: 'priceDesc',
      by: [{ field: 'basePrice', direction: 'desc' }],
    },
    {
      title: 'Title A-Z',
      name: 'titleAsc',
      by: [{ field: 'title', direction: 'asc' }],
    },
  ],
});
